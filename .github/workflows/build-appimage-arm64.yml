name: Build AppImage (arm64)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-arm64-github:
    # Request a GitHub-hosted ARM64 runner by including the arm64 label.
    # Note: GitHub will only dispatch to an ARM64 hosted runner if your account/org has availability.
    runs-on: ubuntu-24.04-arm

    # Run the same Fedora-based environment as your original workflow; on an ARM64 runner
    # this container will be native arm64 (no QEMU).
    container:
      image: fedora:rawhide

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies (Fedora)
        run: |
          set -euxo pipefail
          dnf -y update
          dnf install -y \
            meson \
            ninja-build \
            vala \
            gtk4-devel \
            libadwaita-devel \
            glib2-devel \
            libgee-devel \
            pkgconf \
            desktop-file-utils \
            patchelf \
            squashfs-tools \
            python3-pip \
            python3-setuptools \
            python3-virtualenv \
            gcc \
            gcc-c++ \
            zsync

      - name: Set up Python venv and install AppImage-Builder
        run: |
          set -euxo pipefail
          python3 -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install appimage-builder

      - name: Build Wattage
        run: |
          set -euxo pipefail
          source .venv/bin/activate
          meson setup _build -Dbuildtype=debug
          ninja -C _build
          glib-compile-schemas --targetdir=_build/data data || true

      - name: Prepare AppDir
        run: |
          set -euxo pipefail
          source .venv/bin/activate
          rm -rf _build/AppDir
          meson install -C _build --no-rebuild --destdir "AppDir"

      - name: Build AppImage
        run: |
          set -euxo pipefail
          source .venv/bin/activate
          appimage-builder --appdir _build/AppDir --recipe AppImageBuilder.yml --skip-tests
          # Move the produced AppImage to a stable filename for artifacts/releases
          shopt -s nullglob || true
          for f in *.AppImage _build/*.AppImage _build/AppDir/*.AppImage; do
            if [ -f "$f" ]; then
              mv "$f" Wattage-latest-aarch64.AppImage || true
              break
            fi
          done || true

      - name: List workspace (debug)
        run: ls -la

      - name: Upload AppImage artifact (arm64)
        uses: actions/upload-artifact@v4
        with:
          name: Wattage-AppImage-arm64
          path: Wattage-latest-aarch64.AppImage

      - name: Upload .AppImage to GitHub Release (only for releases)
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: "*.AppImage"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
