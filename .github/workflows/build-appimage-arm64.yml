name: Build AppImage (arm64)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-arm64:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU emulation (allow running arm64 containers on x86 runners)
        uses: docker/setup-qemu-action@v2

      - name: Build inside an arm64 Fedora container
        run: |
          set -euxo pipefail
          # Run a single container invocation (arm64) and execute the full build inside it.
          # Mount the workspace so generated AppImage is available to the runner for artifact upload.
          docker run --platform linux/arm64 --rm \
            -v "${GITHUB_WORKSPACE}":/work -w /work \
            arm64v8/fedora:rawhide /bin/bash -lc '
              set -euxo pipefail

              # Install build dependencies
              dnf -y update
              dnf install -y \
                meson \
                ninja-build \
                vala \
                gtk4-devel \
                libadwaita-devel \
                glib2-devel \
                libgee-devel \
                pkgconf \
                desktop-file-utils \
                patchelf \
                squashfs-tools \
                python3-pip \
                python3-setuptools \
                python3-virtualenv \
                gcc \
                gcc-c++ \
                zsync

              # Set up Python venv and install AppImage-Builder
              python3 -m venv .venv
              source .venv/bin/activate
              pip install --upgrade pip
              pip install appimage-builder

              # Build Wattage
              source .venv/bin/activate
              meson setup _build -Dbuildtype=debug
              ninja -C _build
              # compile schemas into build tree
              glib-compile-schemas --targetdir=_build/data data || true

              # Prepare AppDir
              rm -rf _build/AppDir
              meson install -C _build --no-rebuild --destdir "AppDir"

              # Build AppImage
              source .venv/bin/activate
              appimage-builder --appdir _build/AppDir --recipe AppImageBuilder.yml --skip-tests

              # Normalize AppImage name for artifact upload
              # Move any generated AppImage to a predictable name in workspace root
              shopt -s nullglob || true
              for f in *.AppImage _build/*.AppImage _build/AppDir/*.AppImage; do
                if [ -f "$f" ]; then
                  mv "$f" Wattage-latest-aarch64.AppImage
                  break
                fi
              done || true
            '

      - name: List workspace (debug)
        run: ls -la

      - name: Upload AppImage artifact (arm64)
        uses: actions/upload-artifact@v4
        with:
          name: Wattage-AppImage-arm64
          path: Wattage-latest-aarch64.AppImage

      - name: Upload .AppImage to GitHub Release (only for releases)
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: "*.AppImage"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
