name: Build AppImage

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: fedora:rawhide
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install build dependencies
        run: |
          dnf install -y \
            meson \
            ninja-build \
            vala \
            gtk4-devel \
            libadwaita-devel \
            glib2-devel \
            libgee-devel \
            pkgconf \
            desktop-file-utils \
            patchelf \
            squashfs-tools \
            python3-pip \
            python3-setuptools \
            gcc \
            gcc-c++ \
            zsync

      - name: Set up Python venv and install AppImage-Builder
        run: |
          python3 -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install appimage-builder

      - name: Build Wattage
        run: |
          source .venv/bin/activate
          meson setup _build -Dbuildtype=debug
          ninja -C _build
          glib-compile-schemas --targetdir=_build/data data

      - name: Prepare AppDir
        run: |
          source .venv/bin/activate
          rm -rf _build/AppDir
          meson install -C _build --no-rebuild --destdir "AppDir"

      - name: Build AppImage
        run: |
          source .venv/bin/activate
          appimage-builder --appdir _build/AppDir --recipe AppImageBuilder.yml --skip-tests

      - name: Upload AppImage artifact
        uses: actions/upload-artifact@v4
        with:
          name: Wattage-AppImage
          path: Wattage-latest-x86_64.AppImage
